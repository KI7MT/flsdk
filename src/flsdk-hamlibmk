#!/usr/bin/python3
# -*- coding: utf-8 -*-
#
# Name..........: FLSDK 0.0.5-rc0
# Execution.....: As normal user type: flsdk-hamlibmk
# Copyright.....: Copyright (C) 2014-2016 Greg Beam, KI7MT
# License.......: GPL-3
# Contributors..: Greg Beam, KI7MT
# Comment.......: Part of the FLSDK Linux Project
#
# FLSDK is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation either version 3 of the License, or
# (at your option) any later version. 
#
# FLSDK is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#-------------------------------------------------------------------------#

# import modules
import os
import datetime
import requests
from bs4 import BeautifulSoup

# set debug mode
debug = 0
ext = ".tar.gz"
filename = "hamlib.mk"
scriptname = str(os.path.basename(__file__))

# process variables
hamlib_url = "http://n0nb.users.sourceforge.net/"

# Get the daily-archive file information on Sourceforge
source = requests.get(hamlib_url)
data = source.text
soup = BeautifulSoup(data)
today = datetime.datetime.now()
dtg = (str(today.year) + str(today.month) + str(today.day))

# now go get the filename
for line in soup.body.findAll('a'):
    if line.has_attr('href'):
        if(line['href'].endswith(ext)):
            if(line['href']):
                if (dtg) in line['href']:
                    a1 = str(line['href'])[:-7].split("-")
                    if debug == 1:
                        print('\n'.join(map(str, a1)))

# Print the results if in debug mode
if debug == 1:
    print("\n" + "Pretty output")
    print("---------------------")
    print("Filename ..: %s" % a1[0])
    print("Version....: %s" % a1[1])
    print("Git Hash...: %s" % a1[2])
    print("Date.......: %s" % a1[3])

# now, lets write some stuff to the file
try:
    os.remove(filename)
except OSError:
    pass

with open(filename, "w") as f:
    f.write("# This file is part of MXE. See LICENSE.md for licensing information.\n")
    f.write("# *-- Auto Generated by FLSDK [ %s ] --*\n\n" % scriptname)
    
    f.write("PKG             := %s\n" % a1[0])
    f.write("$(PKG)_WEBSITE  := https://sourceforge.net/projects/hamlib\n")
    f.write("$(PKG)_IGNORE   := \n")
    f.write("$(PKG)_VERSION  := %s\n" % a1[1])
    f.write("$(PKG)_CHECKSUM := \n")
    f.write("$(PKG)_SUBDIR   := $(PKG)-$($(PKG)_VERSION)\n")
    f.write("$(PKG)_FILE     := $(PKG)-$($(PKG)_VERSION)-%s-%s.tar.gz\n" % (a1[2],a1[3]))
    f.write("$(PKG)_URL      := http://n0nb.users.sourceforge.net/$($(PKG)_FILE)\n")
    f.write("$(PKG)_DEPS     := gcc libxml2 libtool libltdl pthreads libusb1\n\n")
    f.write("define $(PKG)_UPDATE\n")
    f.write("    echo 'TODO: write update script for $(PKG).' >&2;\n")
    f.write("    echo $($(PKG)_VERSION)\n")
    f.write("endef\n\n")

    f.write("define $(PKG)_BUILD\n")
    f.write("    cd '$(1)' && ./configure \\\n")
    f.write("        $(MXE_CONFIGURE_OPTS) \\\n")
    f.write("        --disable-winradio \\\n")
    f.write("        --without-cxx-binding \\\n")
    f.write("        --enable-static \\\n")
    f.write("        --disable-shared\n")
    f.write("    $(MAKE) -C '$(1)' -j '$(JOBS)' install bin_PROGRAMS= sbin_PROGRAMS= noinst_PROGRAMS=\n")
    f.write("endef\n")
    f.close()
