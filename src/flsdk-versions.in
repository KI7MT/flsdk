#!/usr/bin/env bash
#
# Name			: flsdk-versions.sh
# Execution		: Run from withing FLSDK
# Copyright		: @COPYRIGHT@
# Contributors	: @AUTHORS@
# Comment		: Part of the @PROJECT@ Linux Project
#
# flsdk-versions.sh is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation either version 3 of the License, or
# (at your option) any later version. 
#
# flsdk-versions.sh is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#-------------------------------------------------------------------------#

# set directories
HOMEDIR=@HOMEDIR@
DOCS=@DOCDIR@
WATCHD=@WATCHD@

# package install paths
FLAMPI=@FLAMPI@
FLDIGII=@FLDIGII@
FLLOGI=@FLLOGI@
FLMSGI=@FLMSGI@
FLNETI=@FLNETI@
FLRIGI=@FLRIGI@
FLWKEYI=@FLWKEYI@
FLWRAPI=@FLWRAPI@

# various paths
SRCD="$HOMEDIR/src"
TMPD="$HOMEDIR/tmp"
LOGD="$HOMEDIR/logs"
MKRD="$HOMEDIR/mkrd"
VERLOG="$TMPD/ver.tmp"

# Foreground colours
C_R='\033[01;31m'	# red
C_G='\033[01;32m'	# green
C_Y='\033[01;33m'	# yellow
C_C='\033[01;36m'	# cyan
C_NC='\033[01;37m'	# no color

# array for watch files
watch_array=( 'flamp-alpha-watch' 'flamp-watch' 'fldigi-alpha-watch' \
'fllog-alpha-watch' 'fllog-watch' 'flmsg-alpha-watch' 'flmsg-wath' \
'flnet-alpha-watch' 'flnet-watch' 'flrig-alpha-watch' 'flrig-watch' \
'flwkey-alpha-watch' 'flwkey-watch' 'flwrap-alpha-watch' 'flwrap-watch')

# Spinner Original Credit: http://fitnr.com/showing-a-bash-spinner.html
# Modified by: KI7MT
spinner()
{
    local pid=$1
    local delay=0.1
    local spinstr='-|-/-\'
    while [ "$(ps a | awk '{print $1}' | grep $pid)" ]; do
        local temp=${spinstr#?}
        printf "[%c]" "$spinstr"
        local spinstr=$temp${spinstr%"$temp"}
        sleep $delay
        printf "\b\b\b\b\b\b"
    done
    printf "    \b\b\b\b"
}

# Test if autoconf is installed
uscan_check() {
uscan --version > /dev/null 2>&1 && echo -e "* Uscan ........ ${C_G}OK${C_NC}" || {
	clear
	echo ''
	echo 'You must have *uscan* from the Debian devscripts'
	echo 'package installed in order to perform version checks.'
	echo ''
	echo 'Due to the number of packages involed with devscripts,'
	echo 'it is not installed as part of the default FLSDK install.'
	echo 'As such, the installation is up to the user to perform.'
	echo ''
	echo 'There are many useful tools included with the package.'
	echo 'It is highly advisable to install it. From a frsh distro'
	echo 'stanpoint, total disk usage is only 3MB after install.'
	echo ''
	echo 'For Debian, Ubuntu and Mint, install with:'
	echo ''
	echo 'sudo apt-get devscripts'
	echo ''
	echo ''
	exit 1
	}
}

# Check Internet connectivity
check_inet() {
((ping -w5 -c3 www.w1hkj.com || ping -w5 -c3 8.8.8.8 || ping -w5 -c3 208.67.222.222) > /dev/null 2>&1) && \
	echo -e "* Internet ..... ${C_G}OK${C_NC}" || {
	echo ''
	echo -e ${C_R}'** INTERNET CONNECTION FAILURE**'${C_NC}
	echo ''
	echo 'You must have internet access inorder to'
	echo 'perform version checks. The following'
	echo 'test failed:'
	echo ''
	echo 'ping -w5 -c3 www.w1hkj.com || ping -w5 -c3 8.8.8.8 || ping -w5 -c3 208.67.222.222'
	echo ''
	echo 'FLDIG Website ...: www.w1hkj.com'
	echo 'Google DNS ......: 8.8.8.8'
	echo 'OpenDNS .........: 208.67.222.222'
	echo ''
	echo 'Check you can access the internet, resolve any connection'
	echo "problems, then re-run Check Version"
	echo ''
	read -p "Press [ Enter ] to continue ..."
	exit 1
	}
}

# check access too git repository on sourceforge
sf_check() {
((git ls-remote git://git.code.sf.net/p/fldigi/fldigi HEAD) > /dev/null 2>&1) && \
	echo -e "* Sourceforge .. ${C_G}OK${C_NC}" || {
	echo ''
	echo -e ${C_R}'** SOURCEFORGE CONNECTION FAILURE**'${C_NC}
	echo ''
	echo '@PROGRAM@ was unable to check the Git repository'
	echo 'on Sourceforge. This may be a temporary fault or'
	echo 'you may have internet connections issues.'
	echo ''
	echo 'If the problems presists, check that you can browse to the'
	echo 'Git Repo on SF, and chek their Net Operations messages on'
	echo 'on Twitter'
	echo ''
	read -p "Press [ Enter ] to continue ..."
	exit 1
	}
}

# remove old file and ensure directories are presnet
mkdir -p "$TMPD"
rm -f "$VERLOG"

# start the check
clear
echo '-----------------------------'
echo -e ${C_Y}'CHECKING VERSION INFORMATION'${C_NC}
echo '-----------------------------'
echo ''
uscan_check
check_inet
sf_check

# add message header to file
echo "APPLICATION RELEASE ALPHA LOCAL-BUILD" > "$VERLOG"
echo '----------- ------- ----- -----------' >> "$VERLOG"

# TO-DO: After the checks have stabalized, reduce the individual checks
# to using an array, then loop through each application.


# FLDIGI version info-----------------------------------------------------------
(

# Check relese builds
fldigi=$(uscan --watchfile @WATCHD@/fldigi-watch --package flmsg --upstream-version 0 --report |grep 'tar.gz')
fldigi_release=$(echo ${fldigi##*/} | sed -r 's/\.[[:alnum:]]+\.[[:alnum:]]+$//' |sed -r 's/^.{7}//')

# Check Alpha builds
if $(uscan --watchfile @WATCHD@/fldigi-alpha-watch --package fldigi --upstream-version 0 --report > /dev/null 2>&1) ; [[ "$?" == "0" ]]; then
	fldigia=$(uscan --watchfile @WATCHD@/fldigi-alpha-watch --package fldigi --upstream-version 0 --report |grep 'tar.gz')
	fldigi_alpha=$(echo ${fldigia##*/} | sed -r 's/\.[[:alnum:]]+\.[[:alnum:]]+$//' |sed -r 's/^.{7}//')
else
	fldigi_alpha="none"
fi

# look for install mkr, set with the build script
if [[ -s @FLDIGII@/version.mkr ]] ; then
	buildv=$(awk -F\| '{print $1}' < @FLDIGII@/version.mkr)
else
	buildv="none"
fi
echo "FLDIGI $fldigi_release $fldigi_alpha $buildv" >> "$VERLOG"

) & spinner $!
echo -e "* FLDIGI ....... ${C_G}Done${C_NC}"

# FLAMP version info------------------------------------------------------------
(

# Check release builds
flamp=$(uscan --watchfile @WATCHD@/flamp-watch --package flmsg --upstream-version 0 --report |grep 'tar.gz')
flamp_release=$(echo ${flamp##*/} | sed -r 's/\.[[:alnum:]]+\.[[:alnum:]]+$//' |sed -r 's/^.{6}//')

# Check Alpha builds
if $(uscan --watchfile @WATCHD@/flamp-alpha-watch --package flamp --upstream-version 0 --report > /dev/null 2>&1) ; [[ "$?" == "0" ]]; then
	flampa=$(uscan --watchfile @WATCHD@/flamp-alpha-watch --package flamp --upstream-version 0 --report |grep 'tar.gz')
	flamp_alpha=$(echo ${flampa##*/} | sed -r 's/\.[[:alnum:]]+\.[[:alnum:]]+$//' |sed -r 's/^.{6}//')
else
	flamp_alpha="none"
fi

# look for install mkr, set with the build script
if [[ -s @FLAMPI@/version.mkr ]] ; then
	buildv=$(awk -F\| '{print $1}' < @FLAMPI@/version.mkr)
else
	buildv="none"
fi

echo "FLAMP $flamp_release $flamp_alpha $buildv" >> "$VERLOG"
) & spinner $!
echo -e "* FLAMP ........ ${C_G}Done${C_NC}"


# FLMSG version info------------------------------------------------------------
(

# Check release builds
flmsg=$(uscan --watchfile @WATCHD@/flmsg-watch --package flmsg --upstream-version 0 --report |grep 'tar.gz')
flmsg_release=$(echo ${flmsg##*/} | sed -r 's/\.[[:alnum:]]+\.[[:alnum:]]+$//' |sed -r 's/^.{6}//')

# Check Alpha builds
if $(uscan --watchfile @WATCHD@/flmsg-alpha-watch --package flmsg --upstream-version 0 --report > /dev/null 2>&1) ; [[ "$?" == "0" ]]; then
	flmsga=$(uscan --watchfile @WATCHD@/flmsg-alpha-watch --package flmsg --upstream-version 0 --report |grep 'tar.gz')
	flmsg_alpha=$(echo ${flmsga##*/} | sed -r 's/\.[[:alnum:]]+\.[[:alnum:]]+$//' |sed -r 's/^.{6}//')
else
	flmsg_alpha="none"
fi

# look for install mkr, set with the build script
if [[ -s @FLMSGI@/version.mkr ]] ; then
	buildv=$(awk -F\| '{print $1}' < @FLMSGI@/version.mkr)
else
	buildv="none"
fi

echo "FLMSG $flmsg_release $flmsg_alpha $buildv" >> "$VERLOG"

) & spinner $!
echo -e "* FLMSG ........ ${C_G}Done${C_NC}"


# FLRIG version info------------------------------------------------------------
(

# Check release builds
flrig=$(uscan --watchfile @WATCHD@/flrig-watch --package flrig --upstream-version 0 --report |grep 'tar.gz')
flrig_release=$(echo ${flrig##*/} | sed -r 's/\.[[:alnum:]]+\.[[:alnum:]]+$//' |sed -r 's/^.{6}//')

# Check Alpha builds
if $(uscan --watchfile @WATCHD@/flrig-alpha-watch --package flrig --upstream-version 0 --report > /dev/null 2>&1) ; [[ "$?" == "0" ]]; then
	flriga=$(uscan --watchfile @WATCHD@/flrig-alpha-watch --package flrig --upstream-version 0 --report |grep 'tar.gz')
	flrig_alpha=$(echo ${flriga##*/} | sed -r 's/\.[[:alnum:]]+\.[[:alnum:]]+$//' |sed -r 's/^.{6}//')
else
	flrig_alpha="none"
fi

# look for install mkr, set with the build script
if [[ -s @FLRIGI@/version.mkr ]] ; then
	buildv=$(awk -F\| '{print $1}' < @FLRIGI@/version.mkr)
else
	buildv="none"
fi

echo "FLRIG $flrig_release $flrig_alpha $buildv" >> "$VERLOG"

) & spinner $!
echo -e "* FLRIG ........ ${C_G}Done${C_NC}"

# FLWKEY version info-----------------------------------------------------------
(

# Check release builds
flwkey=$(uscan --watchfile @WATCHD@/flwkey-watch --package flwkey --upstream-version 0 --report |grep 'tar.gz')
flwkey_release=$(echo ${flwkey##*/} | sed -r 's/\.[[:alnum:]]+\.[[:alnum:]]+$//' |sed -r 's/^.{7}//')

# Check Alpha builds
if $(uscan --watchfile @WATCHD@/flwkey-alpha-watch --package flwkey --upstream-version 0 --report > /dev/null 2>&1) ; [[ "$?" == "0" ]]; then
	flwkeya=$(uscan --watchfile @WATCHD@/flwkey-alpha-watch --package flwkey --upstream-version 0 --report |grep 'tar.gz')
	flwkey_alpha=$(echo ${flwkeya##*/} | sed -r 's/\.[[:alnum:]]+\.[[:alnum:]]+$//' |sed -r 's/^.{7}//')
else
	flwkey_alpha="none"
fi

# look for install mkr, set with the build script
if [[ -s @FLWKEYI@/version.mkr ]] ; then
	buildv=$(awk -F\| '{print $1}' < @FLWKEYI@/version.mkr)
else
	buildv="none"
fi

echo "FLWKEY $flwkey_release $flwkey_alpha $buildv" >> "$VERLOG"
) & spinner $!
echo -e "* FLWKEY ....... ${C_G}Done${C_NC}"

# FLWRAP version info-----------------------------------------------------------
(

# Check release builds
flwrap=$(uscan --watchfile @WATCHD@/flwrap-watch --package flwrap --upstream-version 0 --report |grep 'tar.gz')
flwrap_release=$(echo ${flwrap##*/} | sed -r 's/\.[[:alnum:]]+\.[[:alnum:]]+$//' |sed -r 's/^.{7}//')

# Check Alpha builds
if $(uscan --watchfile @WATCHD@/flwrap-alpha-watch --package flwrap --upstream-version 0 --report > /dev/null 2>&1) ; [[ "$?" == "0" ]]; then
	flwrapa=$(uscan --watchfile @WATCHD@/flwrap-alpha-watch --package flwrap --upstream-version 0 --report |grep 'tar.gz')
	flwrap_alpha=$(echo ${flampa##*/} | sed -r 's/\.[[:alnum:]]+\.[[:alnum:]]+$//' |sed -r 's/^.{6}//')
else
	flwrap_alpha="none"
fi

if [[ -s @FLWRAPI@/version.mkr ]] ; then
	buildv=$(awk -F\| '{print $1}' < @FLWRAPI@/version.mkr)
else
	buildv="none"
fi
echo "FLWRAP $flwrap_release $flwrap_alpha $buildv" >> "$VERLOG"

) & spinner $!
echo -e "* FLWRAP ....... ${C_G}Done${C_NC}"


# FLLOG version info -----------------------------------------------------------
(

# Check release builds
fllog=$(uscan --watchfile @WATCHD@/fllog-watch --package fllog --upstream-version 0 --report |grep 'tar.gz')
fllog_release=$(echo ${fllog##*/} | sed -r 's/\.[[:alnum:]]+\.[[:alnum:]]+$//' |sed -r 's/^.{6}//')

# Check Alpha builds
if $(uscan --watchfile @WATCHD@/fllog-alpha-watch --package fllog --upstream-version 0 --report > /dev/null 2>&1) ; [[ "$?" == "0" ]]; then
	flloga=$(uscan --watchfile @WATCHD@/fllog-alpha-watch --package fllog --upstream-version 0 --report |grep 'tar.gz')
	fllog_alpha=$(echo ${flloga##*/} | sed -r 's/\.[[:alnum:]]+\.[[:alnum:]]+$//' |sed -r 's/^.{6}//')
else
	fllog_alpha="none"
fi

# look for install mkr, set with the build script
if [[ -s @FLLOGI@/version.mkr ]] ; then

	buildv=$(awk -F\| '{print $1}' < @FLLOGI@/version.mkr)
else
	buildv="none"
fi

echo "FLLOG $fllog_release $fllog_alpha $buildv" >> "$VERLOG"

) & spinner $!
echo -e "* FLLOG ........ ${C_G}Done${C_NC}"


# FLNET version info -----------------------------------------------------------
(

# Check release builds
flnet=$(uscan --watchfile @WATCHD@/flnet-watch --package flnet --upstream-version 0 --report |grep 'tar.gz')
flnet_release=$(echo ${flnet##*/} | sed -r 's/\.[[:alnum:]]+\.[[:alnum:]]+$//' |sed -r 's/^.{6}//')

# Check Alpha builds
if $(uscan --watchfile @WATCHD@/flnet-alpha-watch --package flnet --upstream-version 0 --report > /dev/null 2>&1) ; [[ "$?" == "0" ]]; then
	flneta=$(uscan --watchfile flnet-alpha-watch --package flnet --upstream-version 0 --report |grep 'tar.gz')
	flnet_alpha=$(echo ${flneta##*/} | sed -r 's/\.[[:alnum:]]+\.[[:alnum:]]+$//' |sed -r 's/^.{6}//')
else
	flnet_alpha="none"
fi

# look for install mkr, set with the build script
if [[ -s @FLNETI@/version.mkr ]] ; then

	buildv=$(awk -F\| '{print $1}' < @FLNETI@/version.mkr)
else
	buildv="none"
fi

echo "FLNET $flnet_release none $buildv" >> "$VERLOG"

) & spinner $!
echo -e "* FLNET ........ ${C_G}Done${C_NC}"


# simple display results
echo ''
cat "$VERLOG" |column -t
echo ''
echo '*none*, in the local-build column means you have not built'
echo 'the application with @PROGRAM@. If *none* appears in the '
echo 'Alpha column, a tar.gz file was not found on the'
echo 'W1HKJ Software site.'
echo ''
read -p "Press [ Enter ] to continue ..."

exit 0

