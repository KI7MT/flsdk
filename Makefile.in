# Name............: Makefile for FLSDK @VERSION@
# Execution.......: Process this file with autoconf
# Copyright.......: @COPYRIGHT@
# License.........: @LICENSE@
# Contributors....: @AUTHORS@
# Comment.........: Part of the @PROGRAM@ Linux Project
# Dependencies....: AsciiDoc, Autotools, Bash, Core Utils, Git, lsb-release
#                   Python2
#
# TARGETS:
#
# all             - default target, make sure everything gets built
# config-scripts  - configure scripts based on users parameters
# build-doc       - build all documentation 
# build-manp      - build manpages
# build-test      - build test scripts
# install         - install @PROGRAM@
# uninstall       - uninstall @PROGRAM@

# program informaiton
PROGRAM		=	@PROGRAM@
LICENSE		=	@LICENSE@
COPYRIGHT	=	@COPYRIGHT@
VERSION		=	@VERSION@
BUGS		=	@BUGS@
WEB			=	@WEB@

# system informaiton
DESC		=	@DESC@
HOST_OS		=	@HOST_OS@
HOST_CPU	=	@HOST_CPU@
CPUS		=	@CPUS@
JJJJ		=	@JJJJ@

# general tools
AWK			:=	@AWK@
A2X			:=	@A2X@
CP			:=	@CP@
CHOWN		:=	@CHOWN@
CHMOD		:=	@CHMOD@
LN			:=	@LN@
MV			:=	@MV@
RM			:=	@RM@
SED			:=	@SED@
SHELL		:=	@SHELL@
GIT			:=	@GIT@
MKDIR		:=	@MKDIR@

# user, groups and home
HOMEDIR		:=	@HOMEDIR@
LOGNAME		:=	@LOGNAME@
LOGGRP		:=	$(shell groups @LOGNAME@ | cut -d ' ' -f 3)

# system directories
INSTALL		:=	install
PREFIX		:=	@PREFIX@
BINDIR		:=	@BINDIR@
DTDIR		:=	@DTDIR@
DOCDIR		:=	@DOCDIR@
ICOND		:=	@ICOND@
MANDIR		:=	@MANDIR@
SHARE		:=	@SHARE@
WATCHD		:=	@WATCHD@

# manpages and docs
BDOC		:=	@BDOC@
MANP		:=	@MANP@
A2X			:=	@A2X@
ASCIIDOC	:=	@ASCIIDOC@
MANLIST		:=	$(wildcard man/*.1.txt)
INSMAN		:=	$(wildcard man/*.1)

# source directories
DOCSRC		:=	@DOCSRC@
MANSRC		:=	@MANSRC@

# package information
PKGINFO		:=	@PKGINFO@
SCRIPTS		:=	$(src/flsdk src/flsdk-fldigi src/flsdk-flamp src/flsdk-flmsg \
				src/flsdk-flrig src/flsdk-flwkey src/flsdk-fllog src/flsdk-flnet \
				src/flsdk-flwrap src/flsdk-versions)

# enable folder separation
SEPARATE	:=	@SEPARATE@

# config definitions
DEFS		:=	@DEFS@

# foreground colours
C_R			:=	'\033[01;31m'	# red
C_G			:=	'\033[01;32m'	# green
C_Y			:=	'\033[01;33m'	# yellow
C_C			:=	'\033[01;36m'	# cyan
C_NC		:=	'\033[01;37m'	# no color

# Targets
all: conf-scripts build-doc build-manp make-summary

conf-scripts:
	@echo ''
	@echo '---------------------------------------------'
	@echo -e $(C_Y)"Update Build Scripts"$(C_NC)
	@echo '---------------------------------------------'
	@echo '' # Nothing to do at this time.
	@echo " Finished"  
	@echo ''

build-doc:
ifeq ($(BDOC),Yes)
	@echo '---------------------------------------------'
	@echo -e $(C_Y)"Building Documentation"$(C_NC)
	@echo '---------------------------------------------'
	@echo ''
	@echo " Building $(PROGRAM) User Guide..."
	@cd $(DOCSRC); \
	$(ASCIIDOC) -b xhtml11 -a data-uri -a toc2 -o flsdk.html $(DOCSRC)/flsdk-main.adoc
	@echo " Finished"  
	@echo ''
endif

build-manp:
ifeq ($(MANP),Yes)
	@echo '---------------------------------------------'
	@echo -e $(C_Y)"Building Manpages"$(C_NC)
	@echo '---------------------------------------------'
	@echo ''
	@echo " Building $(PROGRAM) Manpages..."
	@for f in $(MANLIST) ; do \
	echo " $$f" ; \
	$(A2X) --doctype manpage --format manpage --no-xmllint $$f ; \
	done
endif

make-summary:
	@echo ''
	@echo '---------------------------------------------'
	@echo -e $(C_G)"MAKE SUMMARY"$(C_NC)
	@echo '---------------------------------------------'
	@echo ''
	@echo " Package ...................: $(PROGRAM) $(VERSION)"
	@echo " Install prefix ............: $(PREFIX)"
	@echo " Working Directory .........: $(HOMEDIR)"
	@echo ''
	@echo ' To Install, type ..........: sudo make install'
	@echo ''

# install @PROGRAM@ @VERSION@
install: install-binaries install-message

under-development:
	@echo ''
	@echo '---------------------------------------------'
	@echo -e $(C_R)"UNDER DEVELOPMENT"$(C_NC)
	@echo '---------------------------------------------'
	@echo '' 
	@echo " $(PROGRAM) is undergoing extensive re-writing."
	@echo ' It is not possible to perform a working installation'
	@echo ' at this time.'
	@echo ''
	@echo " Users should continue to use $(PROGRAM) v0.0.2 until"
	@echo ' further notice.'
	@echo ''

install-binaries:
	@clear
	@echo '---------------------------------------------'
	@echo -e $(C_Y)"Installing $(PROGRAM) $(VERSION)"$(C_NC)
	@echo '---------------------------------------------'
	@echo ''
	@echo '* Setting Up Directories'
	@$(MKDIR) -p $(HOMEDIR)/{src,logs,tmp,mkrd}
	@$(MKDIR) -p $(HOMEDIR)/{flamp,fldigi,fllog,flmsg,flnet,flrig,flwkey,flwrap}
	@$(MKDIR) -p $(DESTDIR)$(BINDIR) $(DESTDIR)$(DOCDIR) $(DESTDIR)$(DTDIR)
	@$(MKDIR) -p $(DESTDIR)$(DOCDIR) $(DESTDIR)$(ICOND) $(DESTDIR)$(MANDIR)
	@$(MKDIR) -p $(DESTDIR)$(SHARE) $(DESTDIR)$(WATCHD)
	@echo "* Changing $(HOMEDIR) Ownership to: [ $(LOGNAME) ]"
	@$(CHOWN) -R $(LOGNAME):$(LOGGRP) $(HOMEDIR)
	@echo '* Installing Scripts'
	@install -m 755 src/flsdk src/flsdk-fldigi src/flsdk-flamp src/flsdk-flmsg \
	src/flsdk-flrig src/flsdk-flwkey src/flsdk-fllog src/flsdk-flnet \
	src/flsdk-flwrap src/flsdk-versions $(DESTDIR)$(BINDIR)
	@install -m 644 src/watch/* $(DESTDIR)$(WATCHD)
	@install -m 644 src/menu/* $(DESTDIR)$(DOCDIR)
	@install -m 644 AUTHORS ChangeLog COPYING COPYRIGHT $(DESTDIR)$(DOCDIR)
	@install -m 644 data/flsdk.desktop $(DESTDIR)$(DTDIR)
	@install -m 644 data/flsdk.xpm $(DESTDIR)$(ICOND)
	@install -m 644 $(PKGINFO) $(DESTDIR)$(DOCDIR)
ifeq ($(BDOC),Yes)
	@echo '* Installing Documentation'
	@install -m -644 $(DOCSRC)/*.html $(DESTDIR)$(DOCDIR)
endif
ifeq ($(MANP),Yes)
	@echo '* Installing Manpages'
	@install -m 644 man/flsdk.1 man/flsdk-fldigi.1 man/flsdk-flamp.1 man/flsdk-flmsg.1 \
	man/flsdk-flrig.1 man/flsdk-flwkey.1 man/flsdk-fllog.1 man/flsdk-flnet.1 \
	man/flsdk-flwrap.1 man/flsdk-versions.1 $(DESTDIR)$(MANDIR)
endif	

install-message:
	@echo ''
	@echo '---------------------------------------------'
	@echo -e $(C_G)"FINISHED INSTALLATION "$(C_NC)
	@echo '---------------------------------------------'
	@echo ''
	@echo " Package ...................: $(PROGRAM) $(VERSION)"
	@echo " Install prefix ............: $(PREFIX)"
	@echo " Home Directory ............: $(HOMEDIR)"
	@echo " Arch.......... ............: $(HOST_CPU)"
	@echo " Distribution ..............: $(DESC)"
	@echo " Enable Folder Separation ..: $(SEPARATE)"
	@echo " With Manpages .............: $(MANP)"
	@echo " With HTML Docs ............: $(BDOC)"
	@echo " CPU Cores .................: $(CPUS)"
	@echo " License ...................: $(LICENSE)"
	@echo " Copyright .................: $(COPYRIGHT)"
	@echo " Project Website ...........: $(WEB)}"
	@echo " Report Bugs To ............: $(BUGS)"
	@echo '' 
	@echo "To Run $(PROGRAM), type ..: flsdk"
	@echo ''

# uninstall @PROGRAM@ @VERSION@
uninstall:
	@clear
	@echo '---------------------------------------------'
	@echo -e $(C_Y)"Uninstall $(PROGRAM) $(VERSION)"$(C_NC)
	@echo '---------------------------------------------'
	@echo ''
	@echo '* Removing installed scripts'
	@$(RM) -f $(DESTDIR)$(BINDIR)/flsdk*
	@echo '* Removing installed docs and manpages'
	@$(RM) -f ${DESTDIR}$(MANDIR)/flsdk*.1
	@echo '* Removing installed share files'
	@$(RM) -rf $(DESTDIR)$(SHARE)
	@$(RM) -f $(DESTDIR)$(ICOND)/flsdk.xpm
	@$(RM) -f $(DESTDIR)$(DTDIR)/flsdk.desktop
	@echo ''
	@echo 'UNINSTALL NOTES'
	@echo ''
	@echo ' 1. All user generated files remain in:'
	@echo "    PATH: $(HOMEDIR)"
	@echo ''

# Cleanup Source Tree
.PHONY: clean
clean:
	${RM} -f src/flsdk src/flsdk-fldigi src/flsdk-flamp src/flsdk-flmsg \
	src/flsdk-flrig src/flsdk-flwkey src/flsdk-fllog src/flsdk-flnet \
	src/flsdk-flwrap src/flsdk-versions config.log config.status \
	configure.scan configure Makefile src/language/language_en \
	data/flsdk.desktop $(PKGINFO)
	${RM} -rf ./autom4*
	$(RM) -f $(DOCSRC)/*.html
	$(RM) -f $(MANSRC)/{*.1,*.1.txt}

